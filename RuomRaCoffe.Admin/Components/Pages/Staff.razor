@page "/staff"
@using RuomRaCoffe.Admin.Services
@using RuomRaCoffe.API.Data.Entities
@using RuomRaCoffe.Shared.Dtos
@inject StaffService StaffService
@inject NavigationManager Navigation

<PageTitle>Staff Management</PageTitle>

<div class="md-container">
    <!-- Header -->
    <div class="md-row md-mb-4">
        <div class="md-col-12">
            <div class="md-d-flex md-justify-content-between md-align-items-center">
                <h1 class="md-d-flex md-align-items-center">
                    <span class="material-icons md-font-size-2xl md-mb-0" style="margin-right: 0.5rem;">people</span>
                    Staff Management
                </h1>
                <div class="md-d-flex">
                    <button class="md-btn md-btn-success md-mb-0" style="margin-right: 0.5rem;" @onclick="() => Navigation.NavigateTo("/staff/checkin")">
                        <span class="material-icons" style="margin-right: 0.25rem;">schedule</span>
                        Check In/Out
                    </button>
                    <button class="md-btn md-btn-primary md-mb-0" @onclick="ShowCreateModal">
                        <span class="material-icons" style="margin-right: 0.25rem;">add</span>
                        Add New Staff
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="md-row md-mb-4">
        <div class="md-col-3">
            <div class="md-card" style="background: linear-gradient(135deg, var(--md-primary), var(--md-primary-dark)); color: white;">
                <div class="md-card-body">
                    <div class="md-d-flex md-justify-content-between md-align-items-center">
                        <div>
                            <h4 class="md-mb-0" style="font-size: var(--md-font-size-sm); opacity: 0.9;">Total Staff</h4>
                            <h2 class="md-mb-0">@(staffList?.Count ?? 0)</h2>
                        </div>
                        <div class="md-align-self-center">
                            <span class="material-icons md-font-size-4xl">people</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="md-col-3">
            <div class="md-card" style="background: linear-gradient(135deg, var(--md-success), var(--md-success-dark)); color: white;">
                <div class="md-card-body">
                    <div class="md-d-flex md-justify-content-between md-align-items-center">
                        <div>
                            <h4 class="md-mb-0" style="font-size: var(--md-font-size-sm); opacity: 0.9;">Currently Working</h4>
                            <h2 class="md-mb-0">@(staffList?.Count(s => s.IsCurrentlyWorking) ?? 0)</h2>
                        </div>
                        <div class="md-align-self-center">
                            <span class="material-icons md-font-size-4xl">schedule</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="md-col-3">
            <div class="md-card" style="background: linear-gradient(135deg, var(--md-info), var(--md-info-dark)); color: white;">
                <div class="md-card-body">
                    <div class="md-d-flex md-justify-content-between md-align-items-center">
                        <div>
                            <h4 class="md-mb-0" style="font-size: var(--md-font-size-sm); opacity: 0.9;">Active Staff</h4>
                            <h2 class="md-mb-0">@(staffList?.Count(s => s.IsActive) ?? 0)</h2>
                        </div>
                        <div class="md-align-self-center">
                            <span class="material-icons md-font-size-4xl">person</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="md-col-3">
            <div class="md-card" style="background: linear-gradient(135deg, var(--md-warning), var(--md-warning-dark)); color: white;">
                <div class="md-card-body">
                    <div class="md-d-flex md-justify-content-between md-align-items-center">
                        <div>
                            <h4 class="md-mb-0" style="font-size: var(--md-font-size-sm); opacity: 0.9;">On Leave</h4>
                            <h2 class="md-mb-0">@(staffList?.Count(s => !s.IsCurrentlyWorking && s.IsActive) ?? 0)</h2>
                        </div>
                        <div class="md-align-self-center">
                            <span class="material-icons md-font-size-4xl">person_off</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="md-row md-mb-3">
        <div class="md-col-12">
            <div class="md-card">
                <div class="md-card-body">
                    <div class="md-row">
                        <div class="md-col-3">
                            <div class="md-text-field">
                                <input type="text" @bind="searchTerm" @bind:event="oninput" placeholder=" " />
                                <label>Search</label>
                            </div>
                        </div>
                        <div class="md-col-3">
                            <div class="md-text-field">
                                <select @bind="statusFilter">
                                    <option value="">All</option>
                                    <option value="working">Currently Working</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                                <label>Status</label>
                            </div>
                        </div>
                        <div class="md-col-3">
                            <div class="md-text-field">
                                <select @bind="roleFilter">
                                    <option value="">All Roles</option>
                                    <option value="Admin">Admin</option>
                                    <option value="Manager">Manager</option>
                                    <option value="Staff">Staff</option>
                                </select>
                                <label>Role</label>
                            </div>
                        </div>
                        <div class="md-col-3 md-d-flex md-align-items-end">
                            <button class="md-btn md-btn-outlined md-mb-0" style="margin-right: 0.5rem;" @onclick="ClearFilters">
                                <span class="material-icons" style="margin-right: 0.25rem;">refresh</span>
                                Clear
                            </button>
                            <button class="md-btn md-btn-primary md-mb-0" @onclick="LoadStaff">
                                <span class="material-icons" style="margin-right: 0.25rem;">search</span>
                                Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Table -->
    @if (isLoading)
    {
        <div class="md-loading">
            <div class="md-spinner"></div>
        </div>
    }
    else
    {
        <div class="md-row">
            <div class="md-col-12">
                <div class="md-card">
                    <div class="md-card-body">
                        <div style="overflow-x: auto;">
                            <table class="md-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Last Check In</th>
                                        <th>Last Check Out</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (filteredStaff != null)
                                    {
                                        @foreach (var staff in filteredStaff)
                                        {
                                            <tr>
                                                <td>
                                                    <div class="md-d-flex md-align-items-center">
                                                        <div class="md-avatar md-mb-0" style="margin-right: 0.5rem;">
                                                            @staff.Name.Substring(0, 1).ToUpper()
                                                        </div>
                                                        <div>
                                                            <h6 class="md-mb-0">@staff.Name</h6>
                                                            <small style="color: var(--md-gray-600);">ID: @staff.Id.ToString().Substring(0, 8)...</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>@staff.Email</td>
                                                <td>@staff.Phone</td>
                                                <td>
                                                    <span class="md-chip md-chip-primary">@staff.Role</span>
                                                </td>
                                                <td>
                                                    @if (staff.IsCurrentlyWorking)
                                                    {
                                                        <span class="md-badge md-badge-success">Working</span>
                                                    }
                                                    else if (staff.IsActive)
                                                    {
                                                        <span class="md-badge md-badge-warning">Available</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="md-badge md-badge-error">Inactive</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (staff.LastCheckIn.HasValue)
                                                    {
                                                        <small>@staff.LastCheckIn.Value.ToString("MM/dd/yyyy HH:mm")</small>
                                                    }
                                                    else
                                                    {
                                                        <small style="color: var(--md-gray-500);">Never</small>
                                                    }
                                                </td>
                                                <td>
                                                    @if (staff.LastCheckOut.HasValue)
                                                    {
                                                        <small>@staff.LastCheckOut.Value.ToString("MM/dd/yyyy HH:mm")</small>
                                                    }
                                                    else
                                                    {
                                                        <small style="color: var(--md-gray-500);">Never</small>
                                                    }
                                                </td>
                                                <td>
                                                    <div class="md-d-flex">
                                                        <button class="md-btn md-btn-text" @onclick="() => ViewStaff(staff.Id)" title="View">
                                                            <span class="material-icons">visibility</span>
                                                        </button>
                                                        <button class="md-btn md-btn-text" @onclick="() => EditStaff(staff.Id)" title="Edit">
                                                            <span class="material-icons">edit</span>
                                                        </button>
                                                        <button class="md-btn md-btn-text" @onclick="() => ViewShiftHistory(staff.Id)" title="Shift History">
                                                            <span class="material-icons">history</span>
                                                        </button>
                                                        <button class="md-btn md-btn-text" style="color: var(--md-error);" @onclick="() => DeleteStaff(staff.Id)" title="Delete">
                                                            <span class="material-icons">delete</span>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<StaffDto>? staffList;
    private List<StaffDto>? filteredStaff;
    private bool isLoading = true;
    private string searchTerm = "";
    private string statusFilter = "";
    private string roleFilter = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadStaff();
    }

    private async Task LoadStaff()
    {
        try
        {
            isLoading = true;
            // TODO: Replace with actual API call when backend is ready
            staffList = new List<StaffDto>
            {
                new StaffDto
                {
                    Id = Guid.NewGuid(),
                    Name = "John Doe",
                    Email = "john@example.com",
                    Phone = "0123456789",
                    Role = "Manager",
                    IsActive = true,
                    IsCurrentlyWorking = true,
                    LastCheckIn = DateTime.Now.AddHours(-2),
                    LastCheckOut = null,
                    CreatedAt = DateTime.Now.AddDays(-30)
                },
                new StaffDto
                {
                    Id = Guid.NewGuid(),
                    Name = "Jane Smith",
                    Email = "jane@example.com",
                    Phone = "0987654321",
                    Role = "Staff",
                    IsActive = true,
                    IsCurrentlyWorking = false,
                    LastCheckIn = DateTime.Now.AddDays(-1),
                    LastCheckOut = DateTime.Now.AddDays(-1).AddHours(8),
                    CreatedAt = DateTime.Now.AddDays(-15)
                }
            };
            ApplyFilters();
        }
        catch (Exception ex)
        {
            // TODO: Add proper error handling with toast notification
            Console.WriteLine($"Error loading staff: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        if (staffList == null) return;

        filteredStaff = staffList.AsEnumerable();

        if (!string.IsNullOrEmpty(searchTerm))
        {
            filteredStaff = filteredStaff.Where(s => 
                s.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                s.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrEmpty(statusFilter))
        {
            filteredStaff = statusFilter switch
            {
                "working" => filteredStaff.Where(s => s.IsCurrentlyWorking),
                "active" => filteredStaff.Where(s => s.IsActive),
                "inactive" => filteredStaff.Where(s => !s.IsActive),
                _ => filteredStaff
            };
        }

        if (!string.IsNullOrEmpty(roleFilter))
        {
            filteredStaff = filteredStaff.Where(s => s.Role == roleFilter);
        }

        filteredStaff = filteredStaff.ToList();
    }

    private void ClearFilters()
    {
        searchTerm = "";
        statusFilter = "";
        roleFilter = "";
        ApplyFilters();
    }

    private void ShowCreateModal()
    {
        Navigation.NavigateTo("/staff/create");
    }

    private void ViewStaff(Guid id)
    {
        Navigation.NavigateTo($"/staff/{id}");
    }

    private void EditStaff(Guid id)
    {
        Navigation.NavigateTo($"/staff/{id}/edit");
    }

    private void ViewShiftHistory(Guid id)
    {
        Navigation.NavigateTo($"/staff/{id}/shifts");
    }

    private async Task DeleteStaff(Guid id)
    {
        // TODO: Implement delete confirmation and API call
        Console.WriteLine($"Delete staff with ID: {id}");
    }
} 