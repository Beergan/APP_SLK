@page "/staff/create"
@using RuomRaCoffe.Admin.Services
@using RuomRaCoffe.API.Data.Entities
@using RuomRaCoffe.Shared.Dtos
@using RuomRaCoffe.Shared.Models
@inject StaffService StaffService
@inject NavigationManager Navigation
@using FluentValidation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
<PageTitle>Staff Management</PageTitle>
<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">
    <MudCard>
        <MudCardHeader>
            <MudText Typo="Typo.h5" Class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Class="mr-3" />
                Create New Staff
            </MudText>
        </MudCardHeader>

        <MudForm Model="@staffModel" @ref="@form" Validation="@(staffValidator.ValidateValue)" ValidationDelay="0">
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="staffModel.Name"
                                      For="@(() => staffModel.Name)"
                                      Immediate="true"
                                      Label="Full Name"
                                      Required="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Person" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="staffModel.Email"
                                      For="@(() => staffModel.Email)"
                                      Immediate="true"
                                      Label="Email"
                                      Required="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Email" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="staffModel.Phone"
                                      For="@(() => staffModel.Phone)"
                                      Immediate="true"
                                      Label="Phone Number"
                                      Required="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Phone" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect @bind-Value="staffModel.Role"
                                   For="@(() => staffModel.Role)"
                                   Label="Role"
                                   Required="true"
                                   Adornment="Adornment.Start"
                                   AdornmentIcon="@Icons.Material.Filled.Work">
                            <MudSelectItem Value="@("Staff")">Staff</MudSelectItem>
                            <MudSelectItem Value="@("Manager")">Manager</MudSelectItem>
                            <MudSelectItem Value="@("Admin")">Admin</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="staffModel.Address"
                                      For="@(() => staffModel.Address)"
                                      Immediate="true"
                                      Label="Address"
                                      Lines="3"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.LocationOn" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="staffModel.Password"
                                      For="@(() => staffModel.Password)"
                                      Immediate="true"
                                      Label="Password"
                                      Required="true"
                                      InputType="InputType.Password"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Lock" />
                    </MudItem>
                </MudGrid>
            </MudCardContent>

            <MudCardActions>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Secondary"
                           OnClick="@(() => Navigation.NavigateTo("/staff"))"
                           StartIcon="@Icons.Material.Filled.ArrowBack">
                    Cancel
                </MudButton>
                <MudSpacer />
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="@(async () => await CreateStaffs())"
                           Disabled="@isLoading"
                           StartIcon="@Icons.Material.Filled.Save">
                    @if (isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Creating...</span>
                    }
                    else
                    {
                        <span>Create Staff</span>
                    }
                </MudButton>
            </MudCardActions>
        </MudForm>
    </MudCard>
</MudContainer>
@code {
    private MudForm form;
    private bool isLoading = false;
    public StaffModel staffModel = new StaffModel();
    private StaffModelFluentValidator staffValidator = new();


    public class StaffModelFluentValidator : AbstractValidator<StaffModel>
    {
        public StaffModelFluentValidator()
        {
            RuleFor(x=>x.Name).NotEmpty().WithMessage("Name is required.")
				.MaximumLength(100).WithMessage("Name cannot exceed 100 characters.");
                RuleFor(x => x.Email).NotEmpty().WithMessage("Email is required.")
                .EmailAddress().WithMessage("Invalid email format.")
                .MaximumLength(100).WithMessage("Email cannot exceed 100 characters.");
            RuleFor(x => x.Address).NotNull().WithMessage("Address is required.");
			RuleFor(x => x.Phone).NotEmpty().WithMessage("Phone is required").MaximumLength(10).WithMessage("Phone cannot exceed 10 characters.");
        }
        public Func<object, string, Task<IEnumerable<string>>> ValidateValue => async (model, propertyName) =>
{
   var result = await ValidateAsync(
       ValidationContext<StaffModel>.CreateWithOptions(
           (StaffModel)model,
           x => x.IncludeProperties(propertyName)
       )
   );

   if (result.IsValid)
       return Array.Empty<string>();

    // Nếu không hợp lệ => trả về danh sách lỗi
   return result.Errors.Select(e => e.ErrorMessage);
};
    }
   


    private async Task CreateStaffs()
    {
        try
        {
            // Validate form
            await form.Validate();

            if (!form.IsValid)
            {
                Snackbar.Add("Please fix validation errors", MudBlazor.Severity.Warning);
                return;
            }

            isLoading = true;

            var createStaffDto = new CreateStaffDto
            {
                Name = staffModel.Name,
                Email = staffModel.Email,
                Phone = staffModel.Phone,
                Role = staffModel.Role,
                Address = staffModel.Address,
                Password = staffModel.Password // Lưu ý: Password sẽ được hash ở API
            };

            var createdStaff = await StaffService.CreateStaffAsync(createStaffDto);

            if (createdStaff != null)
            {
                Snackbar.Add($"Staff '{createdStaff.Name}' created successfully!", MudBlazor.Severity.Success);

                var parameters = new DialogParameters
                {
                    ["ContentText"] = $"Staff '{createdStaff.Name}' has been created successfully. Would you like to create another staff member?",
                    ["ButtonText"] = "Create Another",
                    ["Color"] = Color.Primary
                };

                var dialog = await DialogService.ShowMessageBox(
                    "Success",
                    $"Staff '{createdStaff.Name}' created successfully!",
                    yesText: "Create Another",
                    noText: "Go to Staff List",
                    cancelText: "Stay Here"
                );

                if (dialog == true)
                {
                    // Reset form để tạo nhân sự mới
                    staffModel = new StaffModel();
                    await form.ResetAsync();
                }
                else if (dialog == false)
                {
                    Navigation.NavigateTo("/staff");
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating staff: {ex.Message}", MudBlazor.Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    public class StaffModel
    {
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public string Role { get; set; } = "Staff";
        public string Address { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}